# -*- coding: utf-8 -*-
"""app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/19KzaLdU3Svj8DKjH_A4wXD8vHHB0ukmW
"""

import streamlit as st
import pickle

import numpy as np
def load_model():
    with open("ddi_lr_model.pkl", "rb") as f:
        model = pickle.load(f)
    with open("ddi_tfidf.pkl", "rb") as f:
        tfidf = pickle.load(f)
    return model, tfidf

model, tfidf = load_model()

st.write("‚úÖ Model loaded")
# Load saved model & vectorizer
with open("ddi_lr_model.pkl", "rb") as f:
    model = pickle.load(f)

with open("ddi_tfidf.pkl", "rb") as f:
    tfidf = pickle.load(f)


# Risk mapping
def risk_level(prob):
    if prob < 0.25:
        return "Low Risk"
    elif prob < 0.65:
        return "Moderate Risk"
    else:
        return "High Risk"

# Explanation generator
def generate_explanation(prob, words):
    level = risk_level(prob)
    return f"""
Predicted Interaction Risk: {level}

The interaction is classified as {level.lower()} with a probability of {prob:.2f}.
Key medical terms influencing this prediction include:
{', '.join(words)}.
"""

# App UI
st.set_page_config(page_title="Drug Interaction Risk Predictor", layout="centered")

st.title("üíä AI-Based Drug Interaction Risk Predictor")
st.write("Predicts the risk of adverse drug‚Äìdrug interactions using Explainable AI.")

drug1 = st.text_input("Drug 1")
drug2 = st.text_input("Drug 2")

description = st.text_area(
    "Interaction Description",
    placeholder="Enter the drug interaction description here..."
)

if st.button("Predict Interaction Risk"):
    if description.strip() == "":
        st.warning("Please enter an interaction description.")
    else:
        # Vectorize input
        X = tfidf.transform([description])

        # Predict
        prob = model.predict_proba(X)[0][1]
        level = risk_level(prob)

        # Extract top contributing words
        coef = model.coef_[0]
        tfidf_features = tfidf.get_feature_names_out()
        shap_like = X.toarray()[0] * coef
        top_idx = np.argsort(shap_like)[-5:]
        top_words = [tfidf_features[i] for i in top_idx if shap_like[i] > 0]

        st.subheader("üîç Prediction Result")
        st.write(f"**Risk Level:** {level}")
        st.write(f"**Probability:** {prob:.2f}")

        st.subheader("üß† Explanation")
        st.write(generate_explanation(prob, top_words))

